---
title: "modelos_caret"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r functions, include=FALSE}
library(caret)
library(pROC)
library(tidyr)
library(dplyr)
library(ggplot2)
#library(MASS)
library(pscl)
set.seed(42)

# Utilidades
data_split <- function(datos,split){
  
  if(missing(split)){
    split<-0.7
  }
  trainIndex <- createDataPartition(datos$Hijos, p=split, list=FALSE)
  datos_tr <- datos[ trainIndex,]
  datos_vl <- datos[-trainIndex,]
  return(list("entrenamiento" = datos_tr, "validacion" = datos_vl))
}
roc_auc <- function(modelo,datos){
  prediccion <- predict(modelo,newdata = datos , type="prob")
  
  modelo_ROC <- roc(datos$Hijos,prediccion[,"T"], levels = levels(datos$Hijos))
  modelo_AUC <- auc(datos$Hijos,prediccion[,"T"], levels = levels(datos$Hijos))
  plot(modelo_ROC,print.auc=TRUE,legacy.axes=TRUE,xlim=c(1,0),type="S")
  return(list("roc" = modelo_ROC, "auc" = modelo_AUC))
}

confusion_matrix <- function(modelo,datos){
  modelo_prediccion <- predict(modelo,newdata = datos )
  print(confusionMatrix(modelo_prediccion, datos$Hijos ))
}


clasificacion_hijos <- function(df){
  filter_function<- function(x){
    if(x == 0){
      return("N")
    }else{
      return("T")
    }
  }
  clase_hijos <- sapply(df$Hijos,filter_function)
  return(clase_hijos)
}

clasificacion_hijos_general <- function(df){
  filter_function<- function(x){
    if(x == 0){
      return("0")
    }else if(x == 1){
      return("1")
    }else if(x == 2){
      return("2")
    }else if(x >= 3){
      return("3+")
    }
  }
  clase_hijos <- sapply(df$Hijos,filter_function)
  return(clase_hijos)
}


#Modelos
rf <- function(datos_tr,datos_tr_x){
  mtry <- sqrt(ncol(datos_tr_x))
  tunegrid <- expand.grid(.mtry=mtry)
  ctrl <- trainControl(method='repeatedcv', 
                        number=10, 
                        repeats=3)
  rf_fit <-train(Hijos ~ ., data = datos_tr, method = "rf", preProcess = c("center","scale"), tuneGrid   = tunegrid,trControl = ctrl)
  return(rf_fit)
}


knn <-function(datos_tr){
  ctrl <- trainControl(method="cv")
  knn_fit <-train(Hijos ~ ., data = datos_tr, method = "knn", preProcess = c("center","scale"), tuneGrid   = expand.grid(k = 5:10),trControl = ctrl)
  return(knn_fit)
}






```
### Preprocesamiento de los datos


```{r}
datos_pareja <- read.csv2("./DatosCSVProcesados/DatosParejaING.csv")
datos_soltero <- read.csv2("./DatosCSVProcesados/DatosSolteroING.csv")
datos_completos <- read.csv2("./DatosCSVProcesados/DatosCompletosING.csv")

datos_pareja<- datos_pareja[!is.na(datos_pareja$Estrato.vivienda),]
datos_soltero <- datos_soltero[!is.na(datos_soltero$Estrato.vivienda),]
datos_completos <- datos_completos[!is.na(datos_completos$Estrato.vivienda),]

NAs_pareja <- apply(datos_pareja, 2, is.na)
NAs_soltero <- apply(datos_soltero, 2, is.na)
NAs_completos <- apply(datos_completos, 2, is.na)

apply(NAs_pareja, 2, sum)
apply(NAs_soltero, 2, sum)
apply(NAs_completos,2,sum)

```

```{r}
variables_categoricas_p <- datos_pareja %>% 
  select(Sexo.Jefe,Sexo.Conyuge,Tipo.Union,Region,Energia,Trabajo.Jefe,Trabajo.conyuge,Edu.Jefe,Edu.Conyuge,Estrato.vivienda,Uso.tecnologia.Jefe,Uso.tecnologia.conyuge) %>% 
  mutate_if(is.numeric,as.factor)

variables_categoricas_s <- datos_soltero %>% 
  select(Sexo.Jefe,Region,Energia,Trabajo.Jefe,Edu.Jefe,Uso.tecnologia.Jefe,Estrato.vivienda,Tipo.Union) %>% 
  mutate_if(is.numeric,as.factor)

variables_numericas_p <- datos_pareja %>% 
  select(-c(Sexo.Jefe,Sexo.Conyuge,Tipo.Union,Region,Energia,Trabajo.Jefe,Trabajo.conyuge,Edu.Jefe,Edu.Conyuge,Estrato.vivienda,Uso.tecnologia.Jefe,Uso.tecnologia.conyuge))

variables_numericas_s <- datos_soltero %>% 
  select(-c(Sexo.Jefe,Region,Energia,Trabajo.Jefe,Edu.Jefe,Uso.tecnologia.Jefe,Estrato.vivienda,Tipo.Union))

datos_pareja_codificados <- as.data.frame(cbind(variables_numericas_p,variables_categoricas_p))
datos_soltero_codificados<- as.data.frame(cbind(variables_numericas_s,variables_categoricas_s))
```


```{r}
summary(datos_pareja_codificados)
summary(datos_soltero_codificados)
summary(datos_completos)
```
Las variables Codigo , Secuencia.Jefe ,Secuencia.Conyuge y Energia no nos aportan informacion para el modelo


```{r}
datos_pareja_codificados_limpios_clasificacion_general <-data.frame(datos_pareja_codificados_limpios)
datos_pareja_codificados_limpios <- subset(datos_pareja_codificados, select = -c(Secuencia.Jefe,Secuencia.Conyuge,Codigo,Energia) )
datos_pareja_codificados_limpios_clasificacion_general$Hijos <- as.factor(clasificacion_hijos_general(datos_pareja_codificados_limpios))
datos_pareja_codificados_limpios$Hijos <- as.factor(clasificacion_hijos(datos_pareja_codificados_limpios))

datos_soltero_codificados_limpios_clasificacion_general <-data.frame(datos_soltero_codificados_limpios)
datos_soltero_codificados_limpios <- subset(datos_soltero_codificados, select = -c(Secuencia.Jefe,Codigo,Energia) )
datos_soltero_codificados_limpios_clasificacion_general$Hijos <- as.factor(clasificacion_hijos_general(datos_soltero_codificados_limpios))
datos_soltero_codificados_limpios$Hijos <- as.factor(clasificacion_hijos(datos_soltero_codificados_limpios))


datos_completos_limpios <-subset(datos_completos, select = -c(Secuencia.Jefe,Secuencia.Conyuge,Codigo,Energia) )
datos_completos_limpios_clasificacion <- data.frame(datos_completos_limpios)
datos_completos_limpios_clasificacion$Hijos <- as.factor(clasificacion_hijos(datos_completos_limpios_clasificacion))

datos_completos_limpios_clasificacion_completa <- data.frame(datos_completos_limpios)
datos_completos_limpios_clasificacion_completa$Hijos <- as.factor(clasificacion_hijos_general(datos_completos_limpios_clasificacion_completa))

summary(datos_pareja_codificados_limpios)
summary(datos_soltero_codificados_limpios)

```





```{r}
particion_parejas <- data_split(datos_pareja_codificados_limpios)
datos_tr_parejas <- particion_parejas$entrenamiento
datos_tr_parejas_x <- subset(datos_tr_parejas, select = -c(Hijos))
datos_vl_parejas <- particion_parejas$validacion

particion_solteros <- data_split(datos_soltero_codificados_limpios)
datos_tr_solteros <- particion_solteros$entrenamiento
datos_tr_solteros_x <- subset(datos_tr_solteros, select = -c(Hijos))
datos_vl_solteros <- particion_solteros$validacion
```



### Analisis de modelos usando Caret
A continuacion se realizara un analisis de modelos utilizando caret:
- Logistic Regression
- K Neighbors Classifier
- Naive Bayes
- Decision Tree Classifier
- Ridge Classifier
- Random Forest Classifier
- SVM - Linear Kernel

## KNN
# Modelo Parejas
```{r}
  #knn_model_pareja<-knn(datos_tr_parejas)
  print(knn_model_pareja)
  print(plot(knn_model_pareja, print.thres = 0.5, type="S"))
  
  confusion_matrix(knn_model_pareja,datos_vl_parejas)
  roc_auc(knn_model_pareja,datos_vl_parejas)
```



# Modelo Solteros
```{r}
  knn_model_solteros<-knn(datos_tr_solteros)
  print(knn_model_solteros)
  print(plot(knn_model_solteros, print.thres = 0.5, type="S"))
  confusion_matrix(knn_model_solteros,datos_vl_solteros)
  roc_auc(knn_model_solteros,datos_vl_solteros)
```

## Random Forest Classifier - Hijos 0/1
### Modelo Pareja


```{r}
  #rf_modelo_pareja<-rf(datos_tr_parejas,datos_tr_parejas_x)
  print(rf_modelo_pareja)
  #print(plot(rf_modelo_pareja, print.thres = 0.5, type="S"))
  
  confusion_matrix(rf_modelo_pareja,datos_vl_parejas)
  roc_auc(rf_modelo_pareja,datos_vl_parejas)
```

### Modelo Solteros
```{r}
  rf_modelo_solteros<-rf(datos_tr_solteros,datos_tr_solteros_x)
  print(rf_modelo_solteros)
  #print(plot(rf_modelo_pareja, print.thres = 0.5, type="S"))
  
  confusion_matrix(rf_modelo_solteros,datos_vl_solteros)
  roc_auc(rf_modelo_solteros,datos_vl_solteros)
```
## Random Forest Classifier - Hijos General

```{r}
particion_parejas_clasificacion <- data_split(datos_pareja_codificados_limpios_clasificacion_general)
datos_tr_parejas <- particion_parejas$entrenamiento
datos_tr_parejas_x <- subset(datos_tr_parejas, select = -c(Hijos))
datos_vl_parejas <- particion_parejas$validacion

particion_solteros <- data_split(datos_soltero_codificados_limpios)
datos_tr_solteros <- particion_solteros$entrenamiento
datos_tr_solteros_x <- subset(datos_tr_solteros, select = -c(Hijos))
datos_vl_solteros <- particion_solteros$validacion
```

### Modelo Pareja


```{r}
  rf_modelo_pareja_clasificacion<-rf(datos_tr_parejas,datos_tr_parejas_x)
  print(rf_modelo_pareja)
  #print(plot(rf_modelo_pareja, print.thres = 0.5, type="S"))
  
  confusion_matrix(rf_modelo_pareja,datos_vl_parejas)
  roc_auc(rf_modelo_pareja,datos_vl_parejas)
```






```{r}
saveRDS(rf_modelo_pareja, "./Modelos/rf_pareja_hijos0-1.rds")
saveRDS(rf_modelo_solteros, "./Modelos/rf_solteros_hijos0-1.rds")
```


